<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hello World</title>
</head>
<body>
<button onclick="start()">Start</button>

<br/>
<br/>

<div>Raw Markdown:</div>
<div>
    <pre id="markdown"></pre>
</div>

<br/>
<br/>

<div>Rendered Markdown:</div>
<div id="markdown-output"></div>

<script>

    let currentBuffer = '';
    let currentState = 'text';
    let currentElement = null;
    let headingLevel = 0;

    function renderMarkdown(chunk) {
        currentBuffer += chunk
        console.log('nouveau chunk', chunk);
        console.log('buffer', currentBuffer);

        if (currentBuffer.includes('\n')){
            currentElement = null;
            currentState = 'text';
            headingLevel = 0;
            currentBuffer = currentBuffer.split('\n').pop() || '';
        }

        if (currentBuffer.startsWith('#')){
            let level = 0;
            while (currentBuffer[level] === '#' && level < 3 ){
                level++;
            }
            if (level > 0 && level <= 3){
                currentState = 'heading'
                headingLevel = level
                console.log('State changed to heading, level:', headingLevel);
                updateDisplay();
            }
        }
    }


    function updateDisplay(){
        console.log('UpdateDisplay - Current state:', currentState);
        console.log('UpdateDisplay - Current buffer:', currentBuffer);

        const output = document.getElementById('markdown-output');

    if (currentState === 'heading'){
        if (!currentElement){
            currentElement = document.createElement(`h${headingLevel}`);
            output.appendChild(currentElement);
            console.log('Created new heading element:', `h${headingLevel}`);
        }

        const titleContent = currentBuffer.slice(headingLevel).trim();
        currentElement.textContent = titleContent;

        console.log(`Heading level ${headingLevel}`, titleContent);
    }
    }


    /* Do not modify the code below */

    const markdownString = `# Hello World

Let's start with simple
things.
Some code: \`console.log('Hello World')\`

### Getting harder

Some more code:
\`\`\`js
const foobar = 42

const barfoo = 24
\`\`\`
`

    async function start() {
        const rawMarkdown = document.getElementById('markdown')

        for (let i = 0; i < markdownString.length; ) {
            const chunkSize = Math.floor(Math.random() * 5) + 1
            const chunk = markdownString.slice(i, i + chunkSize)
            rawMarkdown.textContent += chunk
            renderMarkdown(chunk)
            i += chunkSize
            await new Promise((resolve) => setTimeout(resolve, 100))
        }
    }
</script>
</body>
</html>
