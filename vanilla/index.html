<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Markdown Streaming Parser</title>
  <style>
    pre {
      background-color: #f5f5f5;
      padding: 10px;
    }
    pre.inline {
      display: inline;
      padding: 0;
      background-color: transparent;
    }
  </style>
</head>
<body>
<button onclick="start()">Start</button>

<div>Raw Markdown:</div>
<div>
  <pre id="markdown"></pre>
</div>

<div>Rendered Markdown:</div>
<div id="markdown-output"></div>

<script>
  let lines = [];
  let buffer = '';

  class LineState {
    constructor() {
      this.type = 'unknown'; // 'unknown', 'heading', 'paragraph', 'codeBlock', 'inlineCode'
      this.headingLevel = 0;
      this.content = '';
      this.element = null;
      this.isAtLineStart = true;
      this.potentialHeading = false;
      this.potentialCodeBlock = false;
      this.codeBlockDelimiter = '';
      this.isInCodeBlock = false;
      this.codeBlockLanguage = '';
      this.collectingLanguageSpecifier = false;
      this.codeBlockEndDelimiter = '';
    }
  }

  function renderMarkdown(chunk) {
    buffer += chunk;

    let i = 0;
    while (i < buffer.length) {
      let char = buffer[i];

      if (lines.length === 0 || lines[lines.length - 1].isLineComplete) {
        lines.push(new LineState());
      }

      let lineState = lines[lines.length - 1];

      if (char === '\n') {
        if (lineState.collectingLanguageSpecifier) {
          lineState.collectingLanguageSpecifier = false;
          if (lineState.codeBlockLanguage) {
            lineState.element.setAttribute('data-language', lineState.codeBlockLanguage);
          }
        } else if (lineState.isInCodeBlock) {
          lineState.content += '\n';
          lineState.element.textContent = lineState.content;
        } else {
          lineState.isLineComplete = true;
          lineState.isAtLineStart = true;
          processLine(lineState);
        }
        i++;
        continue;
      }

      if (lineState.isInCodeBlock) {
        if (lineState.collectingLanguageSpecifier) {
          if (char !== ' ') {
            lineState.codeBlockLanguage += char;
          }
        } else {
          if (char === '`') {
            lineState.codeBlockEndDelimiter += char;
            if (lineState.codeBlockEndDelimiter === '```') {
              lineState.content = lineState.content.slice(0, - (lineState.codeBlockEndDelimiter.length - 1));
              lineState.element.textContent = lineState.content;
              lineState.isInCodeBlock = false;
              lineState.content = '';
              lineState.codeBlockEndDelimiter = '';
              lineState.isLineComplete = true;
              lineState.isAtLineStart = true;
              processLine(lineState);
            }
          } else {
            if (lineState.codeBlockEndDelimiter.length > 0) {
              lineState.content += lineState.codeBlockEndDelimiter;
              lineState.codeBlockEndDelimiter = '';
            }
            lineState.content += char;
            lineState.element.textContent = lineState.content;
          }
        }
        i++;
        continue;
      }

      if (lineState.isAtLineStart) {
        if (char === '#') {
          lineState.potentialHeading = true;
          lineState.headingLevel++;
          if (!lineState.element) {
            lineState.element = document.createElement('h' + lineState.headingLevel);
            document.getElementById('markdown-output').appendChild(lineState.element);
          } else if (lineState.element.tagName !== 'H' + lineState.headingLevel) {
            let newElement = document.createElement('h' + lineState.headingLevel);
            lineState.element.replaceWith(newElement);
            lineState.element = newElement;
          }
        } else if (char === '`') {
          lineState.potentialCodeBlock = true;
          lineState.codeBlockDelimiter += char;
          if (lineState.codeBlockDelimiter === '```') {
            lineState.type = 'codeBlock';
            lineState.isInCodeBlock = true;
            lineState.collectingLanguageSpecifier = true;
            lineState.codeBlockLanguage = '';
            lineState.element = document.createElement('pre');
            document.getElementById('markdown-output').appendChild(lineState.element);
            lineState.codeBlockDelimiter = '';
          }
        } else if (char === ' ') {
          lineState.isAtLineStart = false;
        } else {
          lineState.isAtLineStart = false;
          if (lineState.potentialHeading) {
            lineState.type = 'heading';
            if (lineState.element.tagName !== 'H' + lineState.headingLevel) {
              let newElement = document.createElement('h' + lineState.headingLevel);
              lineState.element.replaceWith(newElement);
              lineState.element = newElement;
            }
          } else if (lineState.potentialCodeBlock) {
            lineState.type = 'paragraph';
            lineState.content += lineState.codeBlockDelimiter + char;
            lineState.codeBlockDelimiter = '';
            if (!lineState.element) {
              lineState.element = document.createElement('div');
              document.getElementById('markdown-output').appendChild(lineState.element);
            }
            lineState.element.textContent = lineState.content;
          } else {
            lineState.type = 'paragraph';
            lineState.content += char;
            if (!lineState.element) {
              lineState.element = document.createElement('div');
              document.getElementById('markdown-output').appendChild(lineState.element);
            }
            lineState.element.textContent = lineState.content;
          }
        }
      } else {
        if (lineState.type === 'unknown') {
          if (lineState.potentialHeading) {
            lineState.type = 'heading';
          } else if (lineState.potentialCodeBlock) {
            lineState.type = 'codeBlock';
          } else {
            lineState.type = 'paragraph';
            if (!lineState.element) {
              lineState.element = document.createElement('div');
              document.getElementById('markdown-output').appendChild(lineState.element);
            }
          }
        }

        if (lineState.type === 'codeBlock') {
        } else if (char === '`' && lineState.type !== 'codeBlock') {
          // Détection du code inline
          if (lineState.isInInlineCode) {
            lineState.isInInlineCode = false;
            lineState.content += char;
            lineState.element.innerHTML = renderInlineCode(lineState.content);
            lineState.content = '';
          } else {
            lineState.isInInlineCode = true;
            lineState.content += char;
          }
        } else {
          lineState.content += char;
          if (lineState.element) {
            if (lineState.type === 'heading' || lineState.type === 'paragraph') {
              if (lineState.isInInlineCode) {
                lineState.element.innerHTML = renderInlineCode(lineState.content);
              } else {
                lineState.element.textContent = lineState.content;
              }
            }
          }
        }
      }

      i++;
    }

    buffer = buffer.slice(i);
  }

  function processLine(lineState) {
    if (lineState.type === 'unknown') {
      lineState.type = 'paragraph';
      if (!lineState.element) {
        lineState.element = document.createElement('div');
        lineState.element.textContent = lineState.content;
        document.getElementById('markdown-output').appendChild(lineState.element);
      }
    }

    lineState.isLineComplete = true;
    lineState.isAtLineStart = true;
    lineState.potentialHeading = false;
    lineState.potentialCodeBlock = false;
    lineState.headingLevel = 0;
    lineState.codeBlockDelimiter = '';
    lineState.content = '';
    lineState.isInInlineCode = false;
    lineState.codeBlockEndDelimiter = '';
  }

  function renderInlineCode(text) {
    return text.replace(/`([^`]+)`/g, function(match, code) {
      return '<pre class="inline">' + code + '</pre>';
    });
  }

  /* Ne modifiez pas le code ci-dessous */

  const markdownString = `# Hello World

Let's start with simple
things.
Some code: \`console.log('Hello World')\`

### Getting harder

Some more code:
\`\`\`js
const foobar = 42

const barfoo = 24
\`\`\`
`;

  async function start() {
    const rawMarkdown = document.getElementById('markdown');
    rawMarkdown.textContent = ''; // Réinitialiser le contenu

    // Réinitialiser les variables d'état globales
    lines = [];
    buffer = '';

    // Vider le contenu précédent rendu
    const markdownOutput = document.getElementById('markdown-output');
    while (markdownOutput.firstChild) {
      markdownOutput.removeChild(markdownOutput.firstChild);
    }

    for (let i = 0; i < markdownString.length; ) {
      const chunkSize = Math.floor(Math.random() * 5) + 1;
      const chunk = markdownString.slice(i, i + chunkSize);
      rawMarkdown.textContent += chunk;
      renderMarkdown(chunk);
      i += chunkSize;
      await new Promise((resolve) => setTimeout(resolve, 100));
    }
  }
</script>
</body>
</html>
